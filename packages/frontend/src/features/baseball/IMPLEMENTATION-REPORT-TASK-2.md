# タスク2実装レポート: 監督指示システムの実装

## 実装日時
2026-02-01

## 担当タスク
- タスク2: 監督指示システムの実装
  - 2.1 (P) 攻撃指示メニューと有効条件
  - 2.2 (P) 守備指示メニューと投手/シフト操作
  - 2.3 指示制限とフィードバック

## 実装内容

### 1. 型定義の追加 (`types/common.ts`)

#### 攻撃指示タイプ
```typescript
export type OffensiveInstruction =
  | 'normal_swing' // 通常打撃
  | 'bunt' // バント
  | 'hit_and_run' // ヒットエンドラン
  | 'steal' // 盗塁
  | 'wait' // 待て
  | 'squeeze' // スクイズ
  | 'double_steal'; // ダブルスチール
```

#### 守備指示タイプ
```typescript
export type DefensiveInstruction =
  | 'normal' // 通常守備
  | 'pitcher_change' // 投手交代
  | 'intentional_walk' // 敬遠
  | 'defensive_shift'; // 守備シフト
```

#### 指示オプションインターフェース
```typescript
export interface InstructionOption {
  type: OffensiveInstruction | DefensiveInstruction;
  label: string; // 表示名
  description: string; // 説明文
  enabled: boolean; // 選択可能かどうか
  warning?: string; // 警告メッセージ
  successRate?: string; // 成功率の目安
}
```

### 2. 攻撃指示メニューコンポーネント (`OffensiveInstructionMenu.tsx`)

#### Requirement 2実装状況

**AC 1-5: 攻撃側の基本指示**
- ✅ AC 1: 打席開始時に利用可能な指示オプションをメニュー形式で表示
- ✅ AC 2: 「通常打撃」選択で打者の通常能力で打席を実行
- ✅ AC 3: 指示を選択して確定・実行
- ✅ AC 4: 各指示オプションに簡潔な説明文と成功率の目安を付与
- ✅ AC 5: タイムアウトせず待機し続ける（ユーザー操作を待つ）

**AC 6-10: ランナーがいる場合の追加指示**
- ✅ AC 6: ランナーが塁上にいる場合、走者関連の指示を選択肢に追加
- ✅ AC 7: ランナーが一塁のみにいる場合、盗塁とエンドランを有効化
- ✅ AC 8: ランナーが三塁にいる場合、スクイズバントを選択肢に追加
- ✅ AC 9: 複数のランナーがいる場合、ダブルスチールを選択肢に追加
- ✅ AC 10: ランナーがいない状態で走者関連指示が選ばれた場合、警告を表示

**AC 16-19: 特殊な状況での指示制限**
- ✅ AC 17: ツーアウト時に盗塁の推奨度を下げる警告を表示
- ⚠️ AC 16: カウントが2ストライクの場合のバント成功率低下（次のタスクで実装予定）
- ⚠️ AC 18: 走者の走力が低い場合の盗塁リスク警告（次のタスクで実装予定）
- ⚠️ AC 19: 大差で負けている場合の警告（次のタスクで実装予定）

#### 主な機能

1. **指示オプションの動的生成**
   - 走者の状況に応じて有効な指示を判定
   - 選手能力に基づく成功率の目安を表示
   - 無効な指示には理由を表示

2. **状況判定**
   - 一塁・二塁・三塁の走者の有無を確認
   - 複数走者の判定
   - アウトカウントによる警告表示

3. **UIコンポーネント**
   - グリッドレイアウトで見やすく表示
   - 有効/無効状態の視覚的区別
   - ホバー効果とアニメーション

### 3. 守備指示メニューコンポーネント (`DefensiveInstructionMenu.tsx`)

#### Requirement 2実装状況

**AC 11-15: 守備側の指示**
- ✅ AC 11: 守備側のターンで守備指示メニューを表示
- ✅ AC 12: 「投手交代」選択時にブルペンの投手一覧と疲労度を表示
- ⚠️ AC 13: 「敬遠」で四球を与える処理（次のタスクで実装予定）
- ✅ AC 14: 「守備シフト」選択時に利用可能なシフトを表示
- ⚠️ AC 15: 守備指示実行後に攻撃側の打席を再開（次のタスクで実装予定）

**AC 20-23: 指示実行のフィードバック**
- ✅ AC 20: 指示内容を表示
- ⚠️ AC 21-23: プレイ結果と成否の説明（次のタスクで実装予定）

#### 主な機能

1. **投手交代サブメニュー**
   - 現在の投手の情報表示（投球数、疲労度）
   - ブルペン投手一覧（球威、制球、変化球の能力値表示）
   - 投手の疲労度による警告表示

2. **守備シフトサブメニュー**
   - 6種類のシフトタイプ
   - 対象打者の情報表示（長打力、打撃傾向）
   - 現在適用中のシフトを強調表示

3. **敬遠判断**
   - 一塁が空いているかをチェック
   - 打者の長打力に基づく推奨表示
   - 大差時の警告

4. **疲労度管理**
   - 投球数に基づく疲労レベル判定（新鮮/普通/疲労/限界）
   - 疲労度に応じた色分け表示

### 4. GameScreenの統合 (`GameScreen.tsx`)

#### 主な変更点

1. **攻撃/守備の自動判定**
   - プレイヤーが攻撃側か守備側かを自動判定
   - 適切なメニューを表示

2. **指示処理ハンドラー**
   - `handleOffensiveInstruction`: 攻撃指示を処理
   - `handleDefensiveInstruction`: 守備指示を処理
   - `handleShiftChange`: 守備シフト変更を処理
   - `handlePitcherChange`: 投手交代を処理

3. **プレイログへの記録**
   - 選択した指示をプレイログに記録
   - 指示のラベル変換機能

## 実装済み Acceptance Criteria

### Requirement 2: プレイ毎の監督指示システム

**攻撃側の基本指示 (AC 1-5)**
- ✅ AC 1: 打席開始時に利用可能な指示オプションをメニュー形式で表示
- ✅ AC 2: 「通常打撃」を選択すると打者の通常能力で打席を実行
- ✅ AC 3: 指示を選択すると確定しプレイを実行
- ✅ AC 4: 各指示オプションに簡潔な説明文を付与
- ✅ AC 5: タイムアウトせず待機し続ける

**ランナーがいる場合の追加指示 (AC 6-10)**
- ✅ AC 6: ランナーが塁上にいる場合、走者関連の指示を選択肢に追加
- ✅ AC 7: ランナーが一塁のみにいる場合、盗塁とエンドランを有効化
- ✅ AC 8: ランナーが三塁にいる場合、スクイズバントを選択肢に追加
- ✅ AC 9: 複数のランナーがいる場合、ダブルスチールを選択肢に追加
- ✅ AC 10: ランナーがいない状態で走者関連指示が選ばれた場合、警告を表示

**守備側の指示 (AC 11-15)**
- ✅ AC 11: 守備側のターンで守備指示メニューを表示
- ✅ AC 12: 「投手交代」を選択するとブルペンの投手一覧と疲労度を表示
- ✅ AC 14: 「守備シフト」を選択すると利用可能なシフトを表示
- ⚠️ AC 13: 「敬遠」で打者に四球を与える（実際の処理は次のタスクで実装）
- ⚠️ AC 15: 守備指示実行後に攻撃側の打席を再開（次のタスクで実装）

**特殊な状況での指示制限 (AC 16-19)**
- ✅ AC 17: ツーアウト時に盗塁の推奨度を下げる警告を表示
- ⚠️ AC 16: カウントが2ストライクの場合のバント成功率低下（次のタスクで実装）
- ⚠️ AC 18: 走者の走力が低い場合の盗塁リスク警告（次のタスクで実装）
- ⚠️ AC 19: 大差で負けている場合の警告（次のタスクで実装）

**指示実行のフィードバック (AC 20-23)**
- ✅ AC 20: 指示が実行される際に指示内容を表示
- ⚠️ AC 21-23: プレイ結果と成否の説明（次のタスクで実装予定）

## 次のタスクで実装予定

1. **プレイ判定システム（タスク3）**
   - 実際の打席判定ロジック
   - 確率計算
   - バント/盗塁/エンドラン等の結果判定

2. **指示制限の詳細実装**
   - カウント状態による制限
   - 選手能力による成功率計算
   - 試合状況による推奨度調整

3. **投手交代とシフトの実際の反映**
   - gameSliceへの投手交代処理
   - 守備シフトの効果計算

## ファイル一覧

### 新規作成ファイル
- `packages/frontend/src/features/baseball/game/OffensiveInstructionMenu.tsx`
- `packages/frontend/src/features/baseball/game/OffensiveInstructionMenu.css`
- `packages/frontend/src/features/baseball/game/DefensiveInstructionMenu.tsx`
- `packages/frontend/src/features/baseball/game/DefensiveInstructionMenu.css`

### 変更ファイル
- `packages/frontend/src/features/baseball/types/common.ts`: 指示関連の型定義を追加
- `packages/frontend/src/features/baseball/game/GameScreen.tsx`: 指示メニューを統合

## テスト方法

1. 開発サーバーを起動
```bash
cd packages/frontend
npm run dev
```

2. ブラウザで `http://localhost:5173` を開く

3. 試合開始後の確認項目：
   - 攻撃ターンで攻撃指示メニューが表示される
   - 走者の状況に応じて指示オプションが変化する
   - 無効な指示には警告が表示される
   - 守備ターンで守備指示メニューが表示される
   - 投手交代サブメニューでブルペン投手を確認できる
   - 守備シフトサブメニューで各シフトを選択できる

## ビルド確認

```bash
npm run build
```

ビルドは成功し、TypeScriptの型エラーはありません。

## 技術的な実装詳細

### 1. 条件付きレンダリング
- `useMemo`を使用して走者状況を効率的に判定
- 選手能力値から成功率を動的に計算

### 2. 状態管理
- Reduxの`useAppSelector`でゲーム状態を取得
- `useAppDispatch`で指示イベントをディスパッチ

### 3. UIデザイン
- CSS Gridでレスポンシブなレイアウト
- ホバー効果とトランジションでユーザビリティ向上
- 色分けによる情報の視覚的区別

### 4. アクセシビリティ
- ボタンの`disabled`属性で無効状態を明示
- 警告メッセージの明確な表示
- レスポンシブデザインで各種デバイスに対応

## 次のステップ

タスク3「打席判定と確率計算の基礎」に進み、実際のプレイ判定ロジックを実装します：
- 投手対打者の一次判定（三振/四球/インプレー）
- 打球種類/方向/強さの決定
- 守備判定への接続
- 疲労/コンディション/左右の補正
