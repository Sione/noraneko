# タスク13.7・13.9 実装レポート

## 実装日時
2026-02-02

## 実装タスク

### タスク13.7: データのインポート/エクスポート
- **要件**: エクスポート対象の選択と保存、インポートの検証と重複処理

### タスク13.9: バックアップと整合性チェック
- **要件**: 自動バックアップと世代管理、破損検出時の復元処理

## 実装内容

### 1. playerStorage.tsの強化

#### 1.1 エクスポート機能の改善
- **ExportOptionsインターフェース**: エクスポート対象の詳細設定
  - `scope`: 'all' | 'team' | 'selected' - エクスポート範囲の選択
  - `includeTeams`: チーム情報を含めるか
  - `teamId`: 特定チームのID
  - `playerIds`: 選択した選手のID配列

- **exportData関数の拡張**:
  - 全選手、特定チーム、選択した選手のエクスポートに対応
  - メタデータ（選手数、チーム数）を含む
  - バージョン情報とエクスポート日時を記録

#### 1.2 インポート機能の強化
- **ImportOptionsインターフェース**: インポート時の詳細設定
  - `overwriteDuplicates`: 重複選手を上書き
  - `skipDuplicates`: 重複選手をスキップ
  - `validateAbilities`: 能力値の厳密な検証
  - `createBackup`: インポート前の自動バックアップ

- **ImportResultインターフェース**: 詳細な結果レポート
  - `imported`: 追加された選手数
  - `overwritten`: 上書きされた選手数
  - `skipped`: スキップされた選手数
  - `errors`: エラー詳細（名前と理由のペア）

- **importData関数の改善**:
  - バージョンチェック
  - インポート前の自動バックアップ
  - 詳細なバリデーション（能力値1-100のチェック）
  - エラー時の詳細なフィードバック

#### 1.3 バックアップ機能の強化
- **自動バックアップ機能**:
  - `autoBackup()`: 最新バックアップから1分以上経過時にのみバックアップを作成
  - 保存処理時に自動的に呼び出される
  - 過度なバックアップ作成を防止

- **バックアップ管理機能**:
  - `createBackup()`: 手動バックアップ作成
  - `deleteBackup()`: 特定バックアップの削除
  - `clearAllBackups()`: すべてのバックアップを削除
  - `restoreFromBackup()`: 復元前に現在データをバックアップ

#### 1.4 整合性チェックの強化
- **IntegrityCheckResultインターフェース**: 詳細な検証結果
  - エラーと警告の分類（severity: 'error' | 'warning'）
  - エラータイプ（player | team | reference | corruption）
  - 詳細統計情報（総数、有効数、孤立選手数、参照エラー数）

- **checkDataIntegrity関数の改善**:
  - 能力値の詳細検証
  - 孤立した選手の検出（どのチームにも所属していない）
  - 参照整合性チェック（存在しない選手への参照）
  - ロースターと打順の重複チェック
  - localStorageの容量チェック（80%以上で警告）

### 2. BackupManager.tsx - バックアップ管理UI

#### 2.1 機能
- バックアップ一覧の表示（最大10世代）
- バックアップの作成・削除・復元
- すべてのバックアップを削除
- バックアップ詳細情報の表示
  - 作成日時
  - データサイズ
  - 選手数・チーム数

#### 2.2 UI/UX
- モーダルダイアログ形式
- 左側: バックアップ一覧（最新バックアップにバッジ表示）
- 右側: 選択したバックアップの詳細
- 復元時の警告メッセージ
- レスポンシブ対応

### 3. ImportExportDialog.tsx - インポート/エクスポート詳細設定

#### 3.1 エクスポート機能
- エクスポート範囲の選択
  - すべての選手
  - 特定のチーム
  - 選択した選手
- チーム情報を含めるかの選択
- エクスポート内容のプレビュー

#### 3.2 インポート機能
- ファイル選択（JSONファイル）
- 重複処理オプション
  - 上書き
  - スキップ
  - 名前変更して追加（デフォルト）
- 能力値の厳密な検証オプション
- インポート結果の詳細表示
  - 追加・上書き・スキップ数
  - エラー詳細（最大5件表示）

#### 3.3 UI/UX
- モーダルダイアログ形式
- ラジオボタンとチェックボックスによる設定
- ファイル情報の表示（ファイル名、サイズ）
- インポート結果の視覚的フィードバック（成功/エラー）
- レスポンシブ対応

### 4. PlayerManagement.tsxの更新

#### 4.1 統合
- BackupManagerコンポーネントの統合
- ImportExportDialogコンポーネントの統合
- 新しいダイアログの表示状態管理

#### 4.2 UIの改善
- 「バックアップ復元」→「バックアップ管理」ボタンに変更
- インポートボタンを通常のボタンに変更（モーダルトリガー）
- 整合性チェック結果の詳細表示（エラー数と警告数）

## 技術的詳細

### データフォーマット
```typescript
// エクスポートデータ
{
  version: '1.0',
  exportedAt: '2026-02-02T12:00:00.000Z',
  scope: 'all',
  players: Player[],
  teams: Team[],
  metadata: {
    playerCount: number,
    teamCount: number
  }
}

// バックアップデータ
{
  timestamp: number,
  players: Player[],
  teams: Team[]
}
```

### バリデーション
1. **必須フィールドチェック**: id, name, position, batterHand, batting, running, fielding
2. **能力値範囲チェック**: すべての能力値が1-100の範囲内
3. **参照整合性チェック**: チームのロースターと打順が実在する選手を参照
4. **重複チェック**: ロースターと打順内の重複選手の検出

### エラーハンドリング
- try-catchによる例外処理
- 詳細なエラーメッセージ（選手名、エラー理由）
- コンソールへの詳細ログ出力
- ユーザーへの視覚的フィードバック

## テスト推奨項目

### 手動テスト
1. **エクスポート**:
   - [ ] 全選手のエクスポート
   - [ ] 特定チームのエクスポート
   - [ ] 選択した選手のエクスポート
   - [ ] チーム情報の有無でエクスポート

2. **インポート**:
   - [ ] 正常なJSONファイルのインポート
   - [ ] 不正なフォーマットのファイル
   - [ ] 重複選手の処理（上書き/スキップ/名前変更）
   - [ ] 能力値が範囲外のデータ
   - [ ] インポート前後のバックアップ確認

3. **バックアップ**:
   - [ ] 手動バックアップの作成
   - [ ] バックアップからの復元
   - [ ] バックアップの削除
   - [ ] 10世代を超えた場合の古いバックアップの自動削除
   - [ ] 自動バックアップの動作（1分以内の重複防止）

4. **整合性チェック**:
   - [ ] 正常なデータでの整合性チェック
   - [ ] 能力値が不正なデータ
   - [ ] 存在しない選手を参照するチーム
   - [ ] 孤立した選手（どのチームにも所属していない）
   - [ ] ロースター/打順内の重複選手

### ユニットテスト候補
```typescript
// playerStorage.ts
describe('exportData', () => {
  it('should export all players', () => { ... });
  it('should export team players only', () => { ... });
  it('should export selected players', () => { ... });
});

describe('importData', () => {
  it('should import valid data', () => { ... });
  it('should handle duplicates correctly', () => { ... });
  it('should validate abilities', () => { ... });
  it('should create backup before import', () => { ... });
});

describe('checkDataIntegrity', () => {
  it('should detect invalid abilities', () => { ... });
  it('should detect broken references', () => { ... });
  it('should detect orphaned players', () => { ... });
});
```

## 要件との対応

### タスク13.7 (データのインポート/エクスポート)
- ✅ エクスポート対象の選択と保存を行う
  - 全選手、特定チーム、選択した選手の3パターンに対応
  - チーム情報の含有/除外を選択可能
- ✅ インポートの検証と重複処理を行う
  - バージョンチェック
  - 能力値の厳密な検証
  - 重複選手の3つの処理方法（上書き/スキップ/名前変更）
  - 詳細なエラーレポート

### タスク13.9 (バックアップと整合性チェック)
- ✅ 自動バックアップと世代管理を行う
  - 保存時の自動バックアップ（1分間隔で制限）
  - 最大10世代の管理
  - 手動バックアップ作成機能
- ✅ 破損検出時の復元処理を提供する
  - 詳細な整合性チェック（エラー/警告分類、統計情報）
  - バックアップ管理UIからの復元
  - 復元前の自動バックアップ

## ファイル一覧

### 新規作成
- `packages/frontend/src/features/baseball/management/BackupManager.tsx`
- `packages/frontend/src/features/baseball/management/BackupManager.css`
- `packages/frontend/src/features/baseball/management/ImportExportDialog.tsx`
- `packages/frontend/src/features/baseball/management/ImportExportDialog.css`

### 更新
- `packages/frontend/src/features/baseball/data/playerStorage.ts`
- `packages/frontend/src/features/baseball/management/PlayerManagement.tsx`

## 今後の拡張案

1. **エクスポート/インポート**:
   - CSV形式のサポート
   - 複数ファイルの一括インポート
   - インポート時のプレビュー機能

2. **バックアップ**:
   - クラウドストレージへのバックアップ
   - スケジュール自動バックアップ
   - バックアップの圧縮

3. **整合性チェック**:
   - 自動修復機能
   - チェック結果のエクスポート
   - 定期的な自動整合性チェック

## まとめ

タスク13.7と13.9の実装により、以下の機能が提供されました:

1. **柔軟なデータ管理**: エクスポート範囲の選択、重複処理オプション
2. **安全性の向上**: 自動バックアップ、復元前バックアップ、詳細な検証
3. **使いやすいUI**: 専用のモーダルダイアログ、視覚的フィードバック
4. **詳細な情報提供**: エラー詳細、統計情報、整合性レポート

これにより、ユーザーは安全かつ柔軟にデータを管理できるようになりました。
