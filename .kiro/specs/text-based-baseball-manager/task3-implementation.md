# タスク3実装確認ドキュメント

## 実装内容

### 3.1 投手対打者の一次判定
**ファイル**: `atBatEngine.ts` - `judgeAtBatOutcome()`

実装済み：
- ✅ 乱数を用いた結果選択の骨格を作成
- ✅ 三振/四球/インプレーの判定を能力値で計算
- ✅ 判定結果に応じて次段階へ遷移

機能：
- `calculateStrikeoutChance()`: 投手の球威・変化球と打者の三振回避・コンタクト能力から三振確率を計算（5-40%）
- `calculateWalkChance()`: 投手の制球力と打者の選球眼から四球確率を計算（2-20%）
- 乱数で三振/四球/インプレーを決定

### 3.2 打球種類/方向/強さの決定
**ファイル**: `atBatEngine.ts` - `determineBatBall()`

実装済み：
- ✅ ゴロ/フライ/ライナーの分布を計算
- ✅ 利き手と打球傾向で方向分布を調整
- ✅ 強さ判定と長打補正を適用

機能：
- `determineBatType()`: 投手のゴロ率と打者のBABIPからゴロ/フライ/ライナーを決定
- `determineBatDirection()`: 打者の利き手に応じてプル（引っ張り）/センター/逆方向の確率分布を適用
  - 右打者：右方向35%、中堅右20%、センター20%、中堅左15%、左方向10%
  - 左打者：左方向35%、中堅左20%、センター20%、中堅右15%、右方向10%
- `determineBatStrength()`: コンタクト能力とBABIPから弱い/普通/強い/非常に強いを決定
- `calculateExtraBasePotential()`: 長打力と打球種類・強さから長打の可能性（0-100）を計算

### 3.3 守備判定への接続とヒット種類決定
**ファイル**: `atBatEngine.ts`, `defensiveEngine.ts`

実装済み：
- ✅ 守備判定へ渡す打球情報を整理（`DefensivePlayInput`インターフェース）
- ✅ ヒット種類の確定条件を評価

機能：
- `DefensivePlayInput`: 打球情報、打者、走者、アウトカウントを含む構造
- `processDefensivePlay()`: 打球情報を受け取り、守備判定を実行
- `determineSimpleOutcome()`: 簡易的な結果判定（タスク4で詳細実装予定）
  - 本塁打：フライ + 長打可能性80%以上 + 非常に強い打球
  - 三塁打：長打可能性70%以上 + 強い打球
  - 二塁打：長打可能性50%以上 + 弱くない打球
  - 単打/アウト：守備能力と打球の強さで判定

### 3.4 状態補正（疲労/コンディション/左右）
**ファイル**: `atBatEngine.ts`

実装済み：
- ✅ 投球数による疲労減衰を計算
- ✅ 打者コンディションの上下を反映
- ✅ 左右の組み合わせ補正を適用

機能：
- `getConditionModifier()`: コンディションによる能力補正
  - excellent: +10
  - good: +5
  - normal: 0
  - poor: -5
  - terrible: -10
  
- `getFatigueModifier()`: 疲労度と投球数による能力補正
  - fresh: 0
  - normal: -2
  - tired: -5
  - exhausted: -10
  - 投球数補正：60球超-3、80球超-5、100球超-8

- `getHandMatchupModifier()`: 左右の組み合わせ補正
  - 同じ利き手（投手有利）: -5
  - 逆の利き手（打者有利）: +5
  - スイッチヒッター: 0

## GameScreenへの統合

**ファイル**: `GameScreen.tsx` - `handleOffensiveInstruction()`

実装済み：
- ✅ 攻撃指示時に打席判定エンジンを呼び出し
- ✅ 判定結果に応じた処理（三振/四球/インプレー）
- ✅ 守備判定エンジンへの接続
- ✅ 走者の進塁処理と得点加算
- ✅ プレイログへの記録

## gameSliceへの追加

**ファイル**: `gameSlice.ts`

実装済み：
- ✅ `updateRunners`: 走者状態の更新アクション
- ✅ `updatePitchCount`: 投球数の更新アクション

## テスト方法

1. 開発サーバーを起動: `npm run dev`
2. ブラウザで http://localhost:5175 にアクセス
3. チーム選択 → 打順編集 → 試合開始
4. 攻撃指示（通常打撃など）を選択
5. 以下を確認：
   - 三振/四球/ヒット/アウトの判定が正しく行われるか
   - 打球の種類（ゴロ/フライ/ライナー）が表示されるか
   - 走者の進塁が正しく反映されるか
   - 得点が正しく加算されるか
   - プレイログに詳細が記録されるか

## 次のタスクへの接続

タスク4「守備判定とアウト処理」で以下を詳細実装予定：
- 4.1 打球方向に基づく担当選手の特定（シフト対応含む）
- 4.2 ゴロ/フライ/ライナーの詳細な守備処理
- 4.3 併殺/タッチアップ/送球選択
- 4.4 守備エラー詳細と実況

現在は`defensiveEngine.ts`に簡易版を実装済み。
