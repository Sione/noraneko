# タスク3実装完了レポート

## 実装タスク
**タスク3: 打席判定と確率計算の基礎**

## 実装日
2026-02-01

## 実装ファイル

### 新規作成
1. `atBatEngine.ts` - 打席判定エンジン（メインロジック）
2. `defensiveEngine.ts` - 守備判定エンジン（基本構造、タスク4で詳細実装予定）
3. `__tests__/atBatEngine.test.ts` - ユニットテスト
4. `task3-implementation.md` - 実装詳細ドキュメント

### 更新
1. `GameScreen.tsx` - 打席判定エンジンの統合
2. `gameSlice.ts` - 走者更新と投球数更新のアクション追加

## 実装内容サマリー

### 3.1 投手対打者の一次判定 ✅
- **関数**: `judgeAtBatOutcome()`
- **機能**: 
  - 投手の球威・変化球・制球力と打者のコンタクト・三振回避・選球眼から確率計算
  - 三振確率: 5-40%（基本22%、能力差で±18%）
  - 四球確率: 2-20%（基本8%、能力差で±12%）
  - 残り確率でインプレー（打球が飛ぶ）
- **状態補正**: コンディション、疲労、左右の組み合わせを考慮

### 3.2 打球種類/方向/強さの決定 ✅
- **関数**: `determineBatBall()`
- **機能**:
  - **打球種類**: ゴロ/フライ/ライナー
    - 投手のゴロ率と打者のBABIPで決定
    - ライナーは全体の20-25%程度
  - **打球方向**: 5方向（左/中堅左/センター/中堅右/右）
    - 右打者は右方向に引っ張りやすい（35%）
    - 左打者は左方向に引っ張りやすい（35%）
  - **打球の強さ**: 弱い/普通/強い/非常に強い
    - コンタクト能力とBABIPで決定
  - **長打可能性**: 0-100
    - 長打力と打球種類・強さで計算
    - フライとライナーは長打になりやすい

### 3.3 守備判定への接続 ✅
- **インターフェース**: `DefensivePlayInput`
- **機能**:
  - 打球情報を守備判定へ渡す構造を定義
  - 簡易的な守備判定を実装（タスク4で詳細化）
  - 単打/二塁打/三塁打/本塁打/アウト/エラーの判定
  - 走者の進塁処理と得点加算

### 3.4 状態補正（疲労/コンディション/左右） ✅
- **コンディション補正**:
  - excellent: +10
  - good: +5
  - normal: 0
  - poor: -5
  - terrible: -10

- **疲労補正**:
  - fresh: 0
  - normal: -2
  - tired: -5
  - exhausted: -10
  - 投球数補正: 60球超-3、80球超-5、100球超-8

- **左右の組み合わせ補正**:
  - 同じ利き手（投手有利）: -5
  - 逆の利き手（打者有利）: +5
  - スイッチヒッター: 0

## GameScreenへの統合

`handleOffensiveInstruction()`関数で以下のフローを実装：

1. 攻撃指示を受け取る
2. 投球数を更新
3. 打席判定エンジンを呼び出し
4. 判定結果に応じた処理:
   - **三振**: アウトを記録
   - **四球**: 走者を進塁（満塁押し出しも対応）
   - **インプレー**: 守備判定へ接続
5. 守備判定結果を処理:
   - 走者の進塁を更新
   - 得点を加算
   - アウト/次の打者へ遷移
6. プレイログに記録

## テスト

ユニットテストで以下を検証：
- ✅ 三振/四球/インプレーの判定が正常に動作
- ✅ 打球の種類・方向・強さが適切な範囲内
- ✅ 長打可能性が0-100の範囲内
- ✅ コンディションによる能力差の影響
- ✅ 疲労による投手能力の低下
- ✅ 左右の組み合わせによる有利不利

テスト実行方法:
```bash
cd packages/frontend
npm test atBatEngine.test.ts
```

## 動作確認

開発サーバーで以下を確認：
```bash
npm run dev
# http://localhost:5175 にアクセス
```

1. ✅ チーム選択 → 打順編集 → 試合開始
2. ✅ 攻撃指示（通常打撃）を選択
3. ✅ 三振/四球/ヒット/アウトの判定が表示される
4. ✅ 打球の種類が日本語で表示される（例：「センター方向への強いゴロ」）
5. ✅ 走者の進塁が正しく反映される
6. ✅ 得点が正しく加算される
7. ✅ プレイログに詳細が記録される

## 次のタスク

**タスク4: 守備判定とアウト処理**

現在の簡易実装を以下の項目で詳細化：
- 4.1 打球方向に基づく担当選手の特定（シフト対応含む）
- 4.2 ゴロ/フライ/ライナーの詳細な守備処理
- 4.3 併殺/タッチアップ/送球選択
- 4.4 守備エラー詳細と実況

## 備考

- 守備判定エンジンは基本構造のみ実装済み
- 確率的な判定のため、同じ状況でも結果は毎回異なる
- 能力値が極端に高い/低い場合、期待通りの結果になりやすい
- 実際のプレイでバランス調整が必要な場合は確率パラメータを微調整可能

## 技術的詳細

### 使用技術
- TypeScript
- Redux Toolkit (状態管理)
- Vitest (テスティング)

### アーキテクチャ
- エンジン層（atBatEngine, defensiveEngine）とUI層（GameScreen）を分離
- 純粋関数による判定ロジックでテスト容易性を確保
- Redux actionsで状態更新を一元管理

### パフォーマンス
- 判定処理は即座に完了（1ms未満）
- タイマーによる演出遅延のみ（1-2秒）
- 大量のログも100件でアーカイブ化

## 完了チェックリスト

- [x] 3.1 投手対打者の一次判定
- [x] 3.2 打球種類/方向/強さの決定
- [x] 3.3 守備判定への接続とヒット種類決定
- [x] 3.4 状態補正（疲労/コンディション/左右）
- [x] GameScreenへの統合
- [x] gameSliceの更新
- [x] ユニットテストの作成
- [x] ドキュメントの作成
- [x] リンターエラーの解消
- [x] 動作確認

## 実装者コメント

打席判定エンジンの基礎が完成しました。確率計算は現実の野球統計を参考にしつつ、ゲームとして面白くなるようバランス調整しています。

特に以下の点に注力しました：
1. **リアルな確率分布**: 三振率20-25%、四球率8-10%など、実際の野球に近い数値
2. **能力値の影響**: 選手の能力差が適切に結果に反映される
3. **状態補正の実装**: コンディション・疲労・左右の組み合わせが戦略性を生む
4. **拡張性**: タスク4以降で詳細化しやすい設計

次のタスクでは、守備判定をより詳細に実装し、併殺やエラーなどのプレイを追加します。
