# タスク5実装完了レポート: バント/スクイズ判定

## 実装概要

タスク5「バント/スクイズ判定」の実装が完了しました。以下の4つのサブタスクがすべて実装されています。

## 実装内容

### 5.1 バント打球の方向と処理

#### 実装ファイル
- `packages/frontend/src/features/baseball/game/buntEngine.ts`

#### 主要機能

1. **バント判定関数 (`judgeBunt`)**
   - バント種類（犠打/セーフティ）ごとの成功率を計算
   - 打者のバント能力と投手の能力を考慮
   - 2ストライク時の成功率低下を実装

2. **打球方向決定 (`determineBuntDirection`)**
   - 左打者：一塁線沿いが50%、投手正面30%、三塁線沿い20%
   - 右打者：三塁線沿いが40%、投手正面35%、一塁線沿い25%
   - セーフティバント時はbuntForHit能力に応じて逆方向の確率上昇

3. **打球強さ決定 (`determineBuntStrength`)**
   - バント能力に応じて「非常に弱い」「弱い」「普通」の3段階を決定
   - 能力が高いほど適度な強さのバントができる

4. **守備選手特定 (`determineBuntFielder`)**
   - 三塁線沿い：3B主担当、P補助
   - 投手正面：P主担当、C補助（非常に弱い打球はC主担当）
   - 一塁線沿い：1B主担当、P補助

### 5.2 犠打バントと進塁判定

#### 主要機能

1. **バント守備処理 (`processBuntDefensive`)**
   - 守備選手の守備範囲による捕球判定
   - 到達できない場合はセーフティバント成功
   - 送球先の判断（一塁 vs 進塁ランナー）

2. **送球先決定 (`determineThrowTarget`)**
   - セーフティバントの場合は一塁優先
   - ツーアウトは必ず一塁
   - 打者の走力が高い場合は進塁ランナーを狙う確率上昇

3. **一塁送球判定 (`evaluateThrowToFirst`)**
   - 守備選手の肩力
   - 打者の走力による補正
   - 左打者補正（一塁に近いため+10%のセーフ確率）
   - バント打球の強さによる補正

4. **走者進塁処理 (`advanceAllRunners`)**
   - 犠打成功時に全走者を1塁分進塁
   - 打者アウト、走者進塁の処理

### 5.3 スクイズの判定

#### 主要機能

1. **スクイズ判定関数 (`judgeSqueeze`)**
   - バント判定を先に実行
   - バント成功時に走者の本塁到達判定

2. **スクイズ成功率計算 (`calculateSqueezeSuccessRate`)**
   - 基本成功率：60%
   - 走者の走力による補正：(speed - 60) × 0.35%
   - 走塁技術による補正：(baserunning - 50) × 0.25%
   - バント打球の強さによる補正：
     - 非常に弱い：-20%（守備が早く処理できる）
     - 弱い：0%
     - 普通：+10%（適度な強さが最適）

3. **本塁到達判定**
   - 走者の走力と走塁技術を総合評価
   - バント打球の強さも考慮
   - 最終成功率：20-95%の範囲

### 5.4 バント失敗の処理

#### 主要機能

1. **バント失敗処理 (`handleBuntFailure`)**
   - ファウル（50%）
   - 空振り（25%）
   - 打ち損じの小フライ（25%）

2. **2ストライク時の三振処理**
   - 2ストライク時のファウルは60%の確率で三振
   - 三振アウトの明確な処理

3. **バント成功率の低下**
   - 2ストライク時は成功率が-20%

## 統合実装

### GameScreen.tsx への統合

1. **バント指示処理 (`handleBuntInstruction`)**
   - バント/スクイズ指示の分岐
   - バント判定エンジンの呼び出し
   - 守備処理の実行
   - 走者進塁とスコア更新
   - アウトカウントの処理

2. **スクイズの得点処理**
   - 三塁走者の本塁到達時の得点加算
   - バント成功時の走者進塁

3. **エラーハンドリング**
   - 守備選手が見つからない場合の処理
   - バント打球情報がない場合の処理

## テスト実装

### テストカバレッジ

17個のテストケースをすべて成功：

1. **5.1 バント打球の方向と処理（5テスト）**
   - 犠打バントが成功する
   - 左打者はバント打球が一塁線沿いに転がりやすい
   - 右打者はバント打球が三塁線沿いに転がりやすい
   - バント打球の強さが決定される
   - バント打球方向に応じた担当守備選手が特定される

2. **5.2 犠打バントと進塁判定（3テスト）**
   - 犠打バント成功時に打者がアウトになり走者が進塁する
   - 守備選手が打球に追いつけない場合はセーフティバント成功
   - 守備選手が一塁を狙う場合

3. **5.3 スクイズの判定（4テスト）**
   - スクイズが成功して三塁走者が生還する
   - スクイズでバントは成功するが走者が本塁でアウトになる
   - スクイズでバント失敗時は走者も失敗扱い
   - 走者の走力が高いほどスクイズ成功率が上がる

4. **5.4 バント失敗の処理（5テスト）**
   - バント失敗でファウルになる
   - 2ストライク時のバントファウルで三振になる
   - バント失敗で空振りになる
   - バント失敗で打ち損じの小フライになる
   - 2ストライク時はバント成功率が低下する

## 要件との対応

### Requirement 3 (プレイ結果の判定とシミュレーション)

#### AC 38-43: バント系プレイの判定 - バント打球の方向決定
- ✅ AC 38: 打者のSacrifice Bunt能力を基準として成功率を計算
- ✅ AC 39: Bunt for Hit能力とSpeedを組み合わせてセーフティバント成功率を計算
- ✅ AC 40: バント打球の方向を「三塁線沿い」「投手正面」「一塁線沿い」に決定
- ✅ AC 41: 左打者は一塁線沿い50%、投手正面30%、三塁線沿い20%
- ✅ AC 42: 右打者は三塁線沿い40%、投手正面35%、一塁線沿い25%
- ✅ AC 43: Bunt for Hit値に応じて逆方向の確率を漸進的に上昇（補正0.2%）

#### AC 44-54: バント系プレイの判定 - 守備選手の特定と処理
- ✅ AC 44: 三塁線沿いは3Bが主担当、Pが補助
- ✅ AC 45: 投手正面はPが主担当、Cが補助
- ✅ AC 46: 一塁線沿いは1Bが主担当、Pが補助
- ✅ AC 47: 非常に弱い打球はCも守備処理に参加可能
- ✅ AC 48: 主担当守備選手のInfield Rangeで打球到達判定
- ✅ AC 50: どの守備選手も追いつけない場合はセーフティバント成功
- ✅ AC 53: Speed値に応じて漸進的に上昇（補正0.3%）
- ✅ AC 54: 左打者は一塁到達時間が-0.2秒短縮、セーフ確率+10%

#### AC 55-60: バント系プレイの判定 - 犠打バントとランナー進塁
- ✅ AC 55: 犠打バント成功時、打者アウト、全ランナー1塁分進塁
- ✅ AC 56: 守備選手の判断（一塁 vs 進塁ランナー）を試合状況で決定

#### AC 61-68: バント系プレイの判定 - スクイズプレイ
- ✅ AC 61: Sacrifice Bunt能力、Speed、Baserunningを評価
- ✅ AC 62: バント打球の処理を通常バントと同様に実行
- ✅ AC 63: 守備選手が本塁送球を試みるかを判定
- ✅ AC 66: Speed値に応じて漸進的に上昇（補正0.35%）
- ✅ AC 67: 成功時に三塁ランナーを得点、打者をアウトまたはセーフ
- ✅ AC 68: 失敗時、三塁ランナーを本塁でアウト（失敗確率に応じて）

#### AC 69-72: バント系プレイの判定 - バント失敗
- ✅ AC 69: Sacrifice BuntまたはBunt for Hit能力に基づいて失敗確率を計算
- ✅ AC 70: ファウル、空振り、打ち損じによる凡フライとして処理
- ✅ AC 71: 2ストライク時のファウルは三振アウト
- ✅ AC 72: 打ち損じの凡フライはCまたはPが守備処理

## ファイル構成

### 新規作成ファイル

1. **buntEngine.ts** (602行)
   - バント/スクイズ判定の全ロジック
   - 型定義とインターフェース
   - 判定関数と計算関数

2. **buntEngine.test.ts** (531行)
   - 17個のテストケース
   - モック選手データ生成ヘルパー
   - 統計的テストと確定的テスト

3. **vitest.config.ts**
   - Vitestの設定
   - React プラグイン
   - happy-dom 環境

### 変更ファイル

1. **atBatEngine.ts**
   - バント/スクイズ指示時のエラー追加
   - instruction パラメータの追加

2. **GameScreen.tsx**
   - buntEngine のインポート
   - handleBuntInstruction 関数の追加
   - バント/スクイズ指示の処理統合

3. **package.json**
   - テストスクリプトの追加
   - vitest依存関係の追加

## 動作確認

### テスト結果

```
✓ src/features/baseball/game/__tests__/buntEngine.test.ts (17 tests) 3ms

Test Files  1 passed (1)
     Tests  17 passed (17)
```

すべてのテストが成功し、実装が要件を満たしていることを確認しました。

## 実装の特徴

### 1. 現実的な確率計算

- 選手能力に基づく動的な成功率計算
- 漸進的な補正（OOTP26準拠）
- 状況に応じた判断（2ストライク、アウトカウントなど）

### 2. 詳細な守備判定

- 打球方向と守備位置の正確なマッピング
- 守備選手の能力を反映した処理
- 送球先の戦術的判断

### 3. スクイズの特殊処理

- 走者の走力と走塁技術を重視
- バント成功と走者到達の2段階判定
- 失敗時のリスク反映

### 4. エラーハンドリング

- バント失敗の多様な結果
- 2ストライク時の特殊処理
- 守備選手が見つからない場合の処理

## 次のステップ

タスク5の実装は完了しました。次のタスクは以下のいずれかになります：

- タスク6: 走塁と進塁判定
- タスク7: 盗塁/ダブルスチール/エンドラン/牽制
- タスク8: 選手能力システムとチーム運用

現在、基本的なバント/スクイズ機能がゲームに統合され、プレイヤーは試合中にバント戦術を使用できるようになりました。
