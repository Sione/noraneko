# タスク14実装レポート: CPU戦術AIの実装

## 実装日時
2026-02-02

## 対応要件
Requirement 10: CPU操作チームの戦術AI (AC 1-72)

## 実装概要

### 1. CPU AIエンジンの作成 (cpuAI.ts)

#### 1.1 基本AI判断と難易度 (AC 1-5)
- `CPUAIEngine`クラスを作成
- 難易度設定: `beginner`, `intermediate`, `expert`
- 思考時間の演出機能 (0.5-1.5秒のランダム待機)
- 戦術判断のランダム性を実装

#### 1.2 攻撃戦術の判断 (AC 6-34)

**通常打撃判断 (AC 6-10)**
- 基本確率85%
- Contact能力70以上: 90-95%
- Contact能力40未満: 70-80%
- 大差で負けている場合は積極的に

**バント判断 (AC 11-15)**
- ツーアウトではバントしない
- ランナー一塁の状況で判定
- 投手(Contact<30)は60%でバント
- Sacrifice Bunt 60以上で15-25%
- クリーンナップでHR Power高い場合は選択しない
- 接戦の7回以降は確率上昇

**盗塁判断 (AC 16-22)**
- ツーアウトでは選択しない（最優先）
- 点差5点以上では選択しない（最優先）
- Stealing Ability 70以上で20-30%
- 投手のHold Runners 80以上で確率半減
- 接戦の7回以降で確率1.5倍

**エンドラン判断 (AC 23-26)**
- Contact 65以上かつSpeed 60以上で10-20%
- カウント打者有利で確率1.5倍
- カウント投手有利(2ストライク)で選択しない
- パワーヒッターは確率半減

**スクイズ判断 (AC 27-31)**
- ツーアウトまたは三塁ランナーなしで選択しない
- Sacrifice Bunt 60以上かつSpeed 60以上で判定
- 接戦の7回以降で15-25%
- ノーアウト/ワンアウトで5-15%

**ダブルスチール判断 (AC 32-34)**
- ツーアウトでは選択しない
- 一塁と三塁: Stealing Ability平均65以上で10-15%
- 一塁と二塁: Stealing Ability平均70以上で5-10%

#### 1.3 守備戦術の判断 (AC 35-50)

**投手交代判断 (AC 35-42)**
- 投球数100球超: 80-90%で交代
- 投球数75球超かつ疲労: 40-60%で交代
- 7回以降の接戦で投球数80球超: 60%で交代

**敬遠判断 (AC 43-47)**
- 点差5点以上では選択しない
- 満塁になる敬遠: 確率80%低下
- 一塁空きでHR Power 80以上: 15-25%
- 8回以降の接戦でHR Power 70以上: 25-35%

**守備シフト判断 (AC 48-50)**
- ランナーが得点圏にいる場合は通常守備
- 基本確率40-60%
- HR Power 80以上で確率1.5倍

#### 1.4 難易度別のAI調整 (AC 63-67)

**初級 (beginner)**
- 最適でない指示を30-40%の確率で選択
- 投手交代を遅らせる（+20球）
- 守備シフト選択確率10-20%

**中級 (intermediate)**
- 最適でない指示を15-20%の確率で選択
- 標準的な戦術判断
- 守備シフト選択確率40-60%

**上級 (expert)**
- ミス判断5%未満
- 高度な戦術活用
- 守備シフト選択確率70-80%

### 2. CPU AI統合フックの作成 (useCPUAI.ts)

#### 2.1 useCPUAIフック
- CPUのターン判定ロジック
- 攻撃指示の自動実行
- 思考時間の待機処理
- 指示実行イベントの記録

#### 2.2 useCPUDefenseフック
- 守備側のターン判定
- 守備指示の自動実行
- 投手交代・敬遠・守備シフトの判断

### 3. 設定システムの拡張

#### 3.1 難易度マッピング (settings.ts)
- ユーザー設定の難易度 (easy/normal/hard) をCPU難易度 (beginner/intermediate/expert) にマップ
- `mapDifficultyToCPU`関数を実装

### 4. GameScreenへの統合

#### 4.1 CPU AIの初期化
- CPU難易度の状態管理
- 設定からの難易度読み込み

#### 4.2 useCPUAIフックの統合
- handleOffensiveInstruction との連携
- handleDefensiveInstruction との連携
- CPUターンでの自動実行

#### 4.3 UI表示の改善
- CPU思考中のメッセージ表示
- CSSアニメーションによる演出

### 5. スタイリングの追加

#### 5.1 GameScreen.css
```css
.cpu-thinking {
  margin-top: 20px;
  padding: 16px;
  background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
  border-radius: 12px;
  text-align: center;
  animation: pulse 1.5s ease-in-out infinite;
}
```

- パルスアニメーション
- グラデーション背景
- 視覚的フィードバック

## 実装の詳細

### 戦術判断コンテキスト
```typescript
export interface TacticalContext {
  inning: number;
  isTopHalf: boolean;
  outs: number;
  runners: {
    first: boolean;
    second: boolean;
    third: boolean;
  };
  scoreDiff: number; // 正の値: CPUチームがリード
  isCloseGame: boolean; // 2点差以内
  isLateInning: boolean; // 7回以降
  batter: PlayerInGame;
  pitcher: PlayerInGame;
  pitchCount: number;
  balls: number;
  strikes: number;
}
```

### 確率正規化
- すべての指示確率の合計を1.0に正規化
- 各指示の相対的な選択確率を維持

### ランダム選択
- 累積確率を使用した加重ランダム選択
- Math.random()による確率的判断

## テスト方法

### 手動テスト手順
1. ゲームを開始
2. CPU操作チームのターンを確認
3. CPU思考中のメッセージが表示されることを確認
4. CPU指示が自動的に実行されることを確認
5. 戦術ログにCPU指示が記録されることを確認

### 難易度テスト
1. 設定画面で難易度を変更
2. 各難易度でCPUの戦術判断が異なることを確認
   - 初級: より保守的な判断
   - 中級: バランスの取れた判断
   - 上級: より積極的で最適な判断

### 戦術テスト
1. 様々な試合状況でCPU判断を確認
   - ランナー状況による戦術変化
   - 点差による戦術変化
   - イニングによる戦術変化

## 制約事項と今後の改善点

### 現在の制約
1. 打順情報の取得が完全ではない
2. 捕手の能力値がコンテキストに含まれていない
3. 次打者の情報が敬遠判断に使用されていない
4. 投手の失点情報が交代判断に使用されていない
5. 打球傾向データが守備シフト判断に使用されていない

### 今後の改善
1. より詳細な選手情報の取得
2. 試合統計の追跡と活用
3. 機械学習による戦術最適化
4. プレイヤーの戦術パターン認識と対応
5. AI委譲機能の実装（Requirement 10 AC 73-106）

## 関連ファイル

### 新規作成
- `cpuAI.ts` - CPU AIエンジン本体
- `useCPUAI.ts` - CPU AI統合フック

### 修正
- `settings.ts` - 難易度マッピング追加
- `GameScreen.tsx` - CPU AIフック統合
- `GameScreen.css` - CPU思考中のスタイル追加

## Acceptance Criteria達成状況

### タスク14.1 基本AI判断と難易度
- ✅ AC 1-5: 基本動作、ランダム性、思考時間、難易度設定

### タスク14.2 攻撃戦術の判断
- ✅ AC 6-10: 通常打撃判断
- ✅ AC 11-15: バント戦術
- ✅ AC 16-22: 盗塁戦術
- ✅ AC 23-26: エンドラン戦術
- ✅ AC 27-31: スクイズ戦術
- ✅ AC 32-34: ダブルスチール戦術

### タスク14.3 守備戦術の判断
- ✅ AC 35-42: 投手交代判断
- ✅ AC 43-47: 敬遠判断
- ✅ AC 48-50: 守備シフト判断

### タスク14全般
- ✅ AC 63-67: 難易度別のAI調整
- ✅ AC 68-72: AI判断の透明性と演出

## まとめ

タスク14「CPU戦術AIの実装」を完了しました。CPU操作チームが試合状況に応じて適切な戦術判断を行い、プレイヤーと対戦できるようになりました。難易度設定により、初心者から上級者まで幅広いプレイヤーに対応できます。

CPU AIは以下の主要な戦術を実装しています:
- 通常打撃
- バント（犠打バント、スクイズ）
- 盗塁（通常盗塁、ダブルスチール）
- エンドラン
- 投手交代
- 敬遠
- 守備シフト

各戦術は試合状況（イニング、点差、ランナー状況、アウトカウント）に応じて適切に選択され、選手能力値を考慮した確率的判断が行われます。

今後は、AI委譲機能の実装や、より高度な戦術最適化により、さらにリアルで戦略的な野球ゲーム体験を提供できるようになります。
