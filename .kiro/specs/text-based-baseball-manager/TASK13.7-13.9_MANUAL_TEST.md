# タスク13.7・13.9 手動テストガイド

## テスト環境
- ブラウザ: Chrome/Firefox/Safari（最新版推奨）
- 開発サーバー実行: `npm run dev` または `yarn dev`
- アクセスURL: http://localhost:5173

## 事前準備

### 1. テストデータの準備
```bash
# 開発サーバーを起動
npm run dev

# ブラウザで http://localhost:5173 を開く
# サイドメニューから「選手管理」を選択
```

### 2. サンプルデータの確認
- 初回起動時にサンプル選手データが自動的にロードされる
- 最低でも10人以上の選手がいることを確認

---

## テストシナリオ

### シナリオ1: エクスポート機能のテスト

#### 1.1 全選手のエクスポート
**手順**:
1. 選手管理画面で「エクスポート」ボタンをクリック
2. エクスポートダイアログが表示される
3. 「すべての選手」を選択（デフォルト）
4. 「チーム情報も含める」にチェック
5. 「エクスポート」ボタンをクリック

**期待結果**:
- ✅ JSONファイルがダウンロードされる（ファイル名: `baseball_all_YYYY-MM-DD.json`）
- ✅ ファイルに全選手とチーム情報が含まれている
- ✅ 成功メッセージが表示される
- ✅ ダイアログが自動的に閉じる

#### 1.2 特定チームのエクスポート
**手順**:
1. 「エクスポート」ボタンをクリック
2. 「特定のチーム」を選択
3. チーム選択ドロップダウンからチームを選択
4. 「エクスポート」ボタンをクリック

**期待結果**:
- ✅ JSONファイルがダウンロードされる（ファイル名: `baseball_team_YYYY-MM-DD.json`）
- ✅ ファイルに選択したチームの選手のみが含まれている
- ✅ エクスポートプレビューに正しい選手数が表示される

#### 1.3 チーム情報なしでエクスポート
**手順**:
1. 「エクスポート」ボタンをクリック
2. 「チーム情報も含める」のチェックを外す
3. 「エクスポート」ボタンをクリック

**期待結果**:
- ✅ エクスポートされたJSONの`teams`配列が空
- ✅ `metadata.teamCount`が0

---

### シナリオ2: インポート機能のテスト

#### 2.1 正常なデータのインポート
**手順**:
1. 前のシナリオでエクスポートしたファイルをメモ帳などで開く
2. 選手データの一部を編集（例: 名前を変更、IDを新しくする）
3. ファイルを保存
4. 選手管理画面で「インポート」ボタンをクリック
5. インポートダイアログで編集したファイルを選択
6. 「インポート」ボタンをクリック

**期待結果**:
- ✅ インポートが成功する
- ✅ 「追加: X人」と表示される
- ✅ 選手一覧に新しい選手が追加される
- ✅ インポート前にバックアップが作成される（バックアップ管理で確認）

#### 2.2 重複選手の上書き
**手順**:
1. エクスポートしたファイルを編集（既存選手のIDはそのまま、能力値を変更）
2. 「インポート」ボタンをクリック
3. 「重複する選手を上書き」にチェック
4. ファイルを選択してインポート

**期待結果**:
- ✅ 「上書き: X人」と表示される
- ✅ 選手の能力値が更新される
- ✅ 選手数は変わらない

#### 2.3 重複選手のスキップ
**手順**:
1. 既存選手と同じIDのデータを持つファイルを用意
2. 「インポート」ボタンをクリック
3. 「重複する選手をスキップ」にチェック
4. インポート

**期待結果**:
- ✅ 「スキップ: X人」と表示される
- ✅ 既存の選手データは変更されない

#### 2.4 不正なデータのインポート
**手順**:
1. エクスポートしたファイルを編集
2. 能力値を範囲外に設定（例: `contact: 150`）
3. インポート

**期待結果**:
- ✅ エラーメッセージが表示される
- ✅ エラー詳細に「Invalid abilities: batting.contact: 150」のような情報が含まれる
- ✅ その選手はスキップされる

#### 2.5 不正なファイル形式
**手順**:
1. テキストファイル（.txt）やCSVファイルを選択してインポート

**期待結果**:
- ✅ 「ファイルの読み込みに失敗しました」エラーが表示される

---

### シナリオ3: バックアップ管理のテスト

#### 3.1 バックアップ一覧の表示
**手順**:
1. 「バックアップ管理」ボタンをクリック
2. バックアップ一覧を確認

**期待結果**:
- ✅ バックアップマネージャーモーダルが表示される
- ✅ 左側にバックアップ一覧が表示される
- ✅ 最新のバックアップに「最新」バッジが表示される
- ✅ 各バックアップに作成日時、選手数、チーム数が表示される

#### 3.2 手動バックアップの作成
**手順**:
1. バックアップマネージャーで「新しいバックアップを作成」をクリック
2. バックアップ一覧を確認

**期待結果**:
- ✅ 「バックアップを作成しました」メッセージが表示される
- ✅ 一覧の先頭に新しいバックアップが追加される
- ✅ バックアップ数が1増える

#### 3.3 バックアップの詳細表示
**手順**:
1. バックアップ一覧から任意のバックアップをクリック
2. 右側の詳細エリアを確認

**期待結果**:
- ✅ 作成日時が正しく表示される
- ✅ データサイズが表示される
- ✅ 選手数・チーム数が表示される
- ✅ 「このバックアップから復元」ボタンが表示される

#### 3.4 バックアップからの復元
**手順**:
1. 選手データを変更（例: 選手を削除）
2. バックアップマネージャーを開く
3. 変更前のバックアップを選択
4. 「このバックアップから復元」をクリック
5. 確認ダイアログで「OK」

**期待結果**:
- ✅ 確認ダイアログが表示される（「現在のデータは失われます」警告）
- ✅ 「バックアップから復元しました」メッセージが表示される
- ✅ 選手データが復元される（削除した選手が戻る）
- ✅ 復元前のデータが新しいバックアップとして保存される

#### 3.5 バックアップの削除
**手順**:
1. バックアップを選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで「OK」

**期待結果**:
- ✅ 確認ダイアログが表示される
- ✅ 「バックアップを削除しました」メッセージが表示される
- ✅ 一覧からバックアップが削除される

#### 3.6 すべてのバックアップを削除
**手順**:
1. 「すべて削除」ボタンをクリック
2. 確認ダイアログで「OK」

**期待結果**:
- ✅ 警告ダイアログが表示される（「この操作は取り消せません」）
- ✅ 「すべてのバックアップを削除しました」メッセージが表示される
- ✅ バックアップ一覧が空になる

#### 3.7 バックアップ世代管理（10世代制限）
**手順**:
1. 「新しいバックアップを作成」を11回クリック
2. バックアップ一覧を確認

**期待結果**:
- ✅ バックアップ数が10を超えない
- ✅ 最も古いバックアップが自動的に削除される
- ✅ ヘッダーに「(X/10)」と表示される

---

### シナリオ4: 整合性チェックのテスト

#### 4.1 正常データの整合性チェック
**手順**:
1. 「整合性チェック」ボタンをクリック

**期待結果**:
- ✅ 「データの整合性チェック: 問題なし」メッセージが表示される
- ✅ メッセージが緑色で表示される

#### 4.2 不正データの検出
**手順**:
1. ブラウザの開発者ツールを開く（F12）
2. Consoleタブで以下を実行:
```javascript
// localStorageから選手データを取得
let players = JSON.parse(localStorage.getItem('baseball_custom_players'));
// 能力値を不正な値に変更
players[0].batting.contact = 150;
// 保存
localStorage.setItem('baseball_custom_players', JSON.stringify(players));
```
3. ページをリロード
4. 「整合性チェック」ボタンをクリック
5. 開発者ツールのConsoleを確認

**期待結果**:
- ✅ エラーメッセージが表示される
- ✅ エラー件数が表示される
- ✅ Consoleに詳細なエラー情報が出力される
  - 統計情報
  - エラーリスト
  - 警告リスト

#### 4.3 孤立した選手の検出
**手順**:
1. 選手管理画面で選手を新規作成
2. どのチームにも追加しない
3. 「整合性チェック」ボタンをクリック
4. Consoleを確認

**期待結果**:
- ✅ 警告が表示される
- ✅ Console.logに「Player X is not assigned to any team」と表示される

---

### シナリオ5: 自動バックアップのテスト

#### 5.1 自動バックアップの動作確認
**手順**:
1. バックアップマネージャーを開いて現在のバックアップ数を確認
2. 選手を新規作成して保存
3. すぐに別の選手を新規作成して保存（1分以内）
4. バックアップマネージャーを開いて確認
5. 1分以上待つ
6. 別の選手を新規作成して保存
7. バックアップマネージャーを開いて確認

**期待結果**:
- ✅ 手順4: バックアップ数が1つだけ増える（1分以内の連続保存は1つのバックアップ）
- ✅ 手順7: バックアップ数がさらに1つ増える（1分以上経過したので新しいバックアップ）

---

### シナリオ6: エラーハンドリングのテスト

#### 6.1 localStorageの容量警告
**手順**:
1. 大量の選手データをインポート（100人以上）
2. 「整合性チェック」ボタンをクリック
3. Consoleで警告を確認

**期待結果**:
- ⚠️ ストレージ使用率が80%を超えた場合、Console.logに警告が表示される

#### 6.2 破損したデータの復旧
**手順**:
1. 開発者ツールのConsoleで:
```javascript
localStorage.setItem('baseball_custom_players', '{invalid json}');
```
2. ページをリロード
3. 選手管理画面を開く

**期待結果**:
- ✅ エラーが発生してもアプリケーションがクラッシュしない
- ✅ 空の選手リストが表示される
- ✅ バックアップから復元できる

---

## チェックリスト

### エクスポート機能
- [ ] 全選手のエクスポート
- [ ] 特定チームのエクスポート
- [ ] 選択した選手のエクスポート
- [ ] チーム情報の有無でエクスポート
- [ ] エクスポートファイルの内容確認

### インポート機能
- [ ] 正常なデータのインポート
- [ ] 重複選手の上書き
- [ ] 重複選手のスキップ
- [ ] 名前変更して追加（デフォルト）
- [ ] 能力値が範囲外のデータの拒否
- [ ] 不正なファイル形式の拒否
- [ ] インポート結果の詳細表示
- [ ] インポート前の自動バックアップ

### バックアップ管理
- [ ] バックアップ一覧の表示
- [ ] 手動バックアップの作成
- [ ] バックアップの詳細表示
- [ ] バックアップからの復元
- [ ] 復元前のバックアップ作成
- [ ] バックアップの削除
- [ ] すべてのバックアップを削除
- [ ] 10世代制限の動作
- [ ] 自動バックアップの動作（1分制限）

### 整合性チェック
- [ ] 正常データのチェック
- [ ] 能力値が不正なデータの検出
- [ ] 孤立した選手の検出
- [ ] 存在しない選手を参照するチームの検出
- [ ] ロースター/打順内の重複選手の検出
- [ ] 詳細な統計情報の表示
- [ ] localStorage容量警告

### UI/UX
- [ ] モーダルダイアログの表示・非表示
- [ ] 成功/エラーメッセージの表示
- [ ] ボタンの無効化（条件に応じて）
- [ ] レスポンシブデザインの動作
- [ ] 閉じるボタンの動作
- [ ] オーバーレイクリックで閉じる

---

## トラブルシューティング

### エクスポートしたファイルが開けない
- ファイルがJSON形式であることを確認
- テキストエディタで開いて内容を確認
- ブラウザのダウンロード履歴を確認

### インポートが失敗する
- JSONフォーマットが正しいか確認
- 能力値が1-100の範囲内か確認
- 必須フィールド（id, name, position等）があるか確認
- エラーメッセージの詳細を確認

### バックアップが作成されない
- localStorageが有効か確認（プライベートブラウジングモードでは無効）
- ストレージ容量を確認
- 開発者ツールのConsoleでエラーを確認

### データが復元されない
- 正しいバックアップを選択しているか確認
- ページをリロードして再確認
- 開発者ツールのApplication > Local Storageを確認

---

## テスト完了後の確認事項

- [ ] すべてのシナリオが正常に動作した
- [ ] エラーハンドリングが適切に機能した
- [ ] ユーザーへのフィードバックが適切だった
- [ ] データの整合性が保たれた
- [ ] パフォーマンスに問題がなかった
- [ ] ブラウザのコンソールにエラーがない

---

## 報告

テスト完了後、以下の情報を記録してください:

1. **テスト日時**: 
2. **テスト環境**: ブラウザ名・バージョン
3. **テスト結果**: 成功/失敗
4. **発見された問題**: 
5. **備考**: 

---

## 参考情報

### localStorageの確認方法
1. 開発者ツールを開く（F12）
2. Applicationタブ → Storage → Local Storage
3. `baseball_custom_players`: 選手データ
4. `baseball_custom_teams`: チームデータ
5. `baseball_data_backup`: バックアップデータ

### エクスポートファイルの構造例
```json
{
  "version": "1.0",
  "exportedAt": "2026-02-02T12:00:00.000Z",
  "scope": "all",
  "players": [...],
  "teams": [...],
  "metadata": {
    "playerCount": 30,
    "teamCount": 2
  }
}
```
