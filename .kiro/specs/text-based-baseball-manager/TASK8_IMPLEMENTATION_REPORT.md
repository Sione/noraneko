# タスク8実装報告書: 選手能力システムとチーム運用

## 実装日時
2026年2月1日

## 実装概要
タスク8「選手能力システムとチーム運用」のすべてのサブタスクを実装しました。

## 実装詳細

### 8.1 能力値モデルと分類ロジック ✅

#### 実装ファイル
- `playerAbilityUtils.ts` - 能力値計算と分類ロジック

#### 実装内容
1. **選手タイプ分類**
   - 打者タイプ: `power`, `contact`, `balanced`, `speedster`, `slap`
   - 投手タイプ: `power`, `control`, `groundball`, `balanced`
   - `classifyBatter()` - 打者の能力値から自動判定
   - `classifyPitcher()` - 投手の能力値から自動判定

2. **能力値補正システム**
   - `getConditionModifier()` - コンディションによる補正倍率（0.85～1.1）
   - `getFatigueModifier()` - 疲労度による補正倍率（0.8～1.0）
   - `getPitchCountFatigueModifier()` - 投球数による疲労補正（スタミナ依存）
   - `getHandMatchupModifier()` - 左右の組み合わせ補正（0.9～1.1）

3. **補正適用関数**
   - `applyHandMatchupToBatter()` - 打者能力に左右補正を適用
   - `getAdjustedBattingAbilities()` - すべての補正を適用した打撃能力
   - `getAdjustedPitchingAbilities()` - すべての補正を適用した投球能力

4. **総合評価計算**
   - `calculateBatterOverall()` - 打者の総合評価（打撃50%、走塁20%、守備30%）
   - `calculatePitcherOverall()` - 投手の総合評価（投球90%、守備10%）
   - `calculateOverallRating()` - 統一インターフェース

5. **能力値表示ユーティリティ**
   - `getAbilityGrade()` - S/A/B/C/D/E/Fグレード変換
   - `getAbilityColor()` - 能力値に対応する色コード
   - `getConditionLabel()` - コンディションの日本語表記
   - `getFatigueLabel()` - 疲労度の日本語表記

---

### 8.2 コンディションと疲労の影響 ✅

#### 実装ファイル
- `atBatEngine.ts` - 既存エンジンの更新
- `playerAbilityUtils.ts` - 補正計算ロジック

#### 実装内容
1. **atBatEngineの更新**
   - 古い補正ロジック（加算方式）を削除
   - 新しいユーティリティ関数（乗算方式）に置き換え
   - `getAdjustedBattingAbilities()` と `getAdjustedPitchingAbilities()` を使用

2. **補正システムの統一**
   - すべての能力値補正を`playerAbilityUtils.ts`に集約
   - コンディション、疲労、投球数、左右の補正を統一的に管理
   - 補正値の上限を100に設定（能力値のオーバーフローを防止）

3. **影響範囲**
   - 打席判定（三振/四球/インプレー）
   - 打球の種類・方向・強さ
   - 長打の可能性
   - 守備判定（今後の実装で適用予定）

---

### 8.3 打順・ロースター運用 ✅

#### 実装ファイル
- `lineupUtils.ts` - 打順運用ユーティリティ
- `LineupEdit.tsx` - 打順編集画面の大幅更新
- `gameSlice.ts` - `allPlayers`状態と`updateLineup`アクション追加
- `TeamSetup.tsx` - `allPlayers`データの受け渡し

#### 実装内容
1. **推奨打順生成機能**
   - `generateRecommendedLineup()` - 能力値に基づく最適打順の自動生成
   - 各打順位置（1～9番）ごとに異なる評価基準を適用
     - 1番: 出塁率と走力重視
     - 2番: コンタクトとバント能力重視
     - 3-5番: 長打力重視（クリーンナップ）
     - 6-7番: バランス型
     - 8番: 守備力も考慮
     - 9番: 投手または守備重視

2. **打順編集UI**
   - クリックで打順位置を選択
   - 利用可能な選手リストから選択
   - 総合評価の色分け表示（S～Fグレード）
   - 打順位置の説明表示
   - 入れ替え機能（既に打順にいる選手との入れ替え）

3. **打順評価システム**
   - `evaluateLineup()` - 打順の総合評価
   - 出塁率、長打力、走力、コンタクトの各指標を計算
   - リアルタイムで評価を表示

4. **打順検証**
   - `validateLineup()` - 打順の有効性チェック
   - 人数チェック（9人）
   - 重複チェック
   - 選手存在チェック

5. **状態管理**
   - `GameState.allPlayers` - 全選手データを保持
   - `updateLineup` アクション - 打順の更新
   - 打順変更時に`PlayerInGame`に自動変換

---

### 8.4 試合中の選手表示 ✅

#### 実装ファイル
- `PlayerDisplay.tsx` - 選手情報表示コンポーネント
- `PlayerDisplay.css` - スタイル定義

#### 実装内容
1. **PlayerDisplayコンポーネント**
   - 選手の基本情報表示（ポジション、名前、利き手）
   - 総合評価の色分け表示
   - コンディションと疲労度の表示
   - 投球数の表示（投手の場合）
   - 詳細能力値の表示（オプション）
   - 試合成績の表示（打数、安打、打率、打点、得点）

2. **MatchupDisplayコンポーネント**
   - 投打対決の視覚化
   - 打者と投手の能力比較
   - 左右の有利不利を表示
   - 総合評価の対比

3. **能力値の表示方式**
   - 投手: 球威、変化、制球、スタミナ
   - 野手: ミート、パワー、選球眼、走力
   - 各能力値を色分けで表示（S～Fグレード対応）

4. **レスポンシブデザイン**
   - デスクトップとモバイルに対応
   - グリッドレイアウトの自動調整

---

### 8.5 交代ルールの適用 ✅

#### 実装ファイル
- `substitutionUtils.ts` - 選手交代システム
- `gameSlice.ts` - 交代管理の状態とアクション

#### 実装内容
1. **交代タイプの定義**
   - `pinch_hitter` - 代打
   - `pinch_runner` - 代走
   - `defensive_replacement` - 守備固め
   - `pitcher_change` - 投手交代

2. **再出場不可ルールの実装**
   - `PlayerGameStatus` インターフェースで出場状態を管理
   - `hasPlayed` - 試合に出場したか
   - `isActive` - 現在アクティブか
   - `validateSubstitution()` - 交代の有効性を検証

3. **推奨選手選択機能**
   - `getRecommendedPinchHitter()` - 推奨代打の選択
     - 左右の有利な組み合わせを優先
     - 現在の打者より打撃能力が高い選手を選択
   - `getRecommendedDefensiveReplacement()` - 推奨守備固めの選択
     - ポジション適性をチェック
     - 現在の選手より守備能力が高い選手を選択
   - `getRecommendedPitcherChange()` - 推奨投手交代の選択
     - 投球能力が高い投手を選択
     - 疲労していない投手を優先

4. **交代実行システム**
   - `makeSubstitution` アクション - 選手交代の実行
   - `applySubstitution()` - 交代後の状態更新
   - `getSubstitutionDescription()` - 交代の説明文生成
   - 交代履歴の記録
   - イベントログへの追加

5. **状態管理**
   - `GameState.playerStatuses` - 各選手の出場状態
   - `GameState.substitutions` - 交代履歴
   - `startGame`アクションで出場状態を初期化
     - スターティングメンバー: `hasPlayed=true, isActive=true`
     - ベンチメンバー: `hasPlayed=false, isActive=false`

---

### 8.6 能力値の可視化と総合評価 ✅

#### 実装内容
1. **色分けシステム**
   - `getAbilityColor()` - 能力値に対応する色
     - S (90+): 赤 `#ff4444`
     - A (80-89): オレンジ `#ff8800`
     - B (70-79): 黄色 `#ffcc00`
     - C (60-69): 黄緑 `#88cc00`
     - D (50-59): 緑 `#00cc88`
     - E (40-49): 青 `#0088cc`
     - F (0-39): グレー `#888888`

2. **グレード表示**
   - `getAbilityGrade()` - S/A/B/C/D/E/Fグレード変換
   - 能力値の視覚的な評価

3. **総合評価の計算ロジック**
   - 打者: 打撃50% + 走塁20% + 守備30%
   - 投手: 投球90% + 守備10%
   - 各カテゴリ内で重み付け平均を計算

4. **UI統合**
   - `PlayerDisplay`コンポーネントで色分け表示を実装
   - `LineupEdit`で総合評価と色分けを表示
   - すべての能力値表示に統一的なスタイルを適用

---

## 技術的な改善点

### 1. 能力値計算の一元化
- すべての能力値補正を`playerAbilityUtils.ts`に集約
- 計算ロジックの重複を排除
- メンテナンス性の向上

### 2. 型安全性の向上
- 選手タイプの明確な定義
- 交代タイプの列挙
- TypeScriptの型システムを活用

### 3. 再利用可能なコンポーネント
- `PlayerDisplay` - 汎用的な選手情報表示
- `MatchupDisplay` - 投打対決の可視化
- 他の画面でも簡単に利用可能

### 4. 状態管理の改善
- Redux Toolkitを活用した型安全な状態管理
- `allPlayers`で全選手データを一元管理
- `playerStatuses`で出場状態を追跡

---

## テスト推奨項目

### 1. 能力値補正の検証
- コンディション変更時の能力値変動
- 投球数増加による疲労補正
- 左右の組み合わせによる補正

### 2. 打順編集機能
- 推奨打順生成の動作確認
- 打順入れ替えの動作確認
- 打順評価の計算確認

### 3. 選手交代システム
- 再出場不可ルールの動作確認
- 推奨選手選択の動作確認
- 交代後の状態更新確認

### 4. 能力値表示
- 色分けの正確性
- グレード表示の正確性
- レスポンシブデザインの動作確認

---

## 次のステップ

### 短期的な改善
1. 交代選択UIの実装（現在はロジックのみ実装済み）
2. DHルールの完全実装
3. 選手交代時のポジション変更処理

### 中長期的な拡張
1. 選手育成システム
2. 能力値の経年変化
3. 特殊能力の追加
4. より詳細な統計情報の表示

---

## まとめ

タスク8のすべてのサブタスクを完了しました：
- ✅ 8.1 能力値モデルと分類ロジック
- ✅ 8.2 コンディションと疲労の影響
- ✅ 8.3 打順・ロースター運用
- ✅ 8.4 試合中の選手表示
- ✅ 8.5 交代ルールの適用
- ✅ 8.6 能力値の可視化と総合評価

実装された機能により、選手の能力値が試合に正しく反映され、プレイヤーは戦略的な打順編集と選手交代が可能になりました。能力値の可視化により、各選手の強みと弱みが一目で分かるようになりました。
